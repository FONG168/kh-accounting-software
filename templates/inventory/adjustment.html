{% extends "base.html" %}
{% block title %}Stock Adjustment{% endblock %}
{% block content %}
<div class="page-header">
    <h2><i class="bi bi-arrow-left-right me-2"></i>Stock Adjustment</h2>
</div>

<div class="card" style="max-width: 650px;">
    <div class="card-body">
        <form method="POST">
            <div class="row g-3">
                <div class="col-md-12">
                    <label class="form-label">Product *</label>
                    <select name="product_id" id="productSelect" class="form-select" required onchange="showCurrentStock()">
                        <option value="">Select Product</option>
                        {% for p in products %}
                        <option value="{{ p.id }}" data-stock="{{ p.quantity_on_hand }}" data-unit="{{ p.unit }}" data-cost="{{ p.cost_price }}">{{ p.sku }} - {{ p.name }} (Current: {{ p.quantity_on_hand }} {{ p.unit }})</option>
                        {% endfor %}
                    </select>
                    <div id="currentStockInfo" class="form-text"></div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date *</label>
                    <input type="date" name="date" class="form-control" value="{{ today.isoformat() }}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Type *</label>
                    <select name="movement_type" class="form-select" required>
                        <option value="out">Stock Out (Reduce)</option>
                        <option value="in">Stock In (Add)</option>
                        <option value="adjustment">Set to Exact Quantity</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quantity *</label>
                    <input type="number" name="quantity" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Reason *</label>
                    <select name="reason" class="form-select" required>
                        {% for val, label in reasons %}
                        <option value="{{ val }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Unit Cost</label>
                    <input type="number" name="unit_cost" id="unitCost" class="form-control" step="0.01" min="0" value="0">
                </div>
                <div class="col-md-12">
                    <label class="form-label">Reference / ID</label>
                    <input type="text" name="reference" class="form-control" placeholder="e.g., Physical count #123, Damage report #456">
                </div>
                <div class="col-md-12">
                    <label class="form-label">Notes</label>
                    <textarea name="notes" class="form-control" rows="2" placeholder="Additional details about this adjustment..."></textarea>
                </div>
            </div>
            <div class="mt-4">
                <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save Adjustment</button>
                <a href="{{ url_for('inventory.stock_movements') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
function showCurrentStock() {
    const sel = document.getElementById('productSelect');
    const info = document.getElementById('currentStockInfo');
    const costInput = document.getElementById('unitCost');
    const opt = sel.options[sel.selectedIndex];
    if (sel.value) {
        const stock = opt.dataset.stock;
        const unit = opt.dataset.unit;
        const cost = opt.dataset.cost;
        info.innerHTML = `<span class="fw-medium">Current stock: <strong>${stock} ${unit}</strong></span>`;
        costInput.value = cost;
    } else {
        info.innerHTML = '';
    }
}
</script>
{% endblock %}
{% endblock %}
