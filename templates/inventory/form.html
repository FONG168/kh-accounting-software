{% extends "base.html" %}
{% block title %}{{ 'Edit' if product else 'New' }} {% if is_service_business %}Service{% else %}Product{% endif %}{% endblock %}
{% block content %}
<div class="page-header">
    <h2><i class="bi {{ 'bi-tools' if is_service_business else 'bi-box-seam' }} me-2"></i>{{ 'Edit' if product else 'New' }} {% if is_service_business %}Service{% else %}Product / Service{% endif %}</h2>
</div>

<div class="card" style="max-width: 850px;">
    <div class="card-body">
        <form method="POST">
            <!-- ─── ITEM TYPE SELECTOR (Product vs Service) ─── -->
            {% if not is_service_business %}
            <div class="mb-4">
                <label class="form-label fw-bold"><i class="bi bi-diagram-3 me-1"></i>Item Type *</label>
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="card border-2 item-type-card {{ 'border-primary active' if not product or (product and product.item_type != 'service') }}"
                             id="card-product" onclick="selectItemType('product')" style="cursor:pointer;">
                            <div class="card-body text-center py-3">
                                <i class="bi bi-box-seam text-primary" style="font-size:1.8rem;"></i>
                                <h6 class="mt-2 mb-1">Product (Inventory)</h6>
                                <small class="text-muted">Tracks stock, COGS, asset account</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-2 item-type-card {{ 'border-success active' if product and product.item_type == 'service' }}"
                             id="card-service" onclick="selectItemType('service')" style="cursor:pointer;">
                            <div class="card-body text-center py-3">
                                <i class="bi bi-tools text-success" style="font-size:1.8rem;"></i>
                                <h6 class="mt-2 mb-1">Service (Non-Inventory)</h6>
                                <small class="text-muted">Revenue only, no stock movement</small>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="item_type" id="itemType" value="{{ product.item_type if product else 'product' }}">
            </div>
            {% else %}
            {# Service business — always service type, no selector needed #}
            <div class="mb-3">
                <div class="alert alert-success py-2 mb-0 d-flex align-items-center gap-2">
                    <i class="bi bi-tools" style="font-size:1.3rem;"></i>
                    <div>
                        <strong>Service Item</strong>
                        <small class="d-block text-muted">Revenue only — no stock tracking, no COGS</small>
                    </div>
                </div>
            </div>
            <input type="hidden" name="item_type" id="itemType" value="service">
            {% endif %}

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">SKU <span class="badge bg-secondary bg-opacity-10 text-secondary" style="font-size:0.65rem;">Auto</span></label>
                    <input type="text" name="sku" class="form-control" value="{{ product.sku if product else next_sku }}" required>
                    {% if not product %}
                    <div class="form-text text-muted">Auto-generated. Edit if needed.</div>
                    {% endif %}
                </div>
                <div class="col-md-8">
                    <label class="form-label">Product Name *</label>
                    <input type="text" name="name" class="form-control" value="{{ product.name if product else '' }}" required>
                </div>

                <!-- ─── SUB-CATEGORY (Contextual) ─────────────── -->
                <div class="col-md-6">
                    <label class="form-label">Sub-Category</label>
                    <select name="sub_category" id="subCategory" class="form-select">
                        <option value="">— Select Sub-Category —</option>
                    </select>
                    <div class="form-text text-muted" id="subCatHint">Classification within item type</div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Category</label>
                    <select name="category_id" id="categorySelect" class="form-select">
                        <option value="">— Select Category —</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" data-type="{{ cat.category_type or 'product' }}"
                                {{ 'selected' if product and product.category_id == cat.id }}>{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">
                        <a href="{{ url_for('categories.create') }}" target="_blank">+ Add new category</a>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Unit</label>
                    <select name="unit" class="form-select">
                        {% for u in ['pcs', 'kg', 'ltr', 'box', 'pack', 'set', 'hr', 'day', 'job', 'session', 'sqft', 'mtr'] %}
                        <option value="{{ u }}" {{ 'selected' if product and product.unit == u }}>{{ u }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ─── ADVANCED CLASSIFICATION ───────────────── -->
                <div class="col-12">
                    <hr class="my-1">
                    <label class="form-label fw-bold" style="font-size:0.9rem;"><i class="bi bi-sliders me-1"></i>Advanced Classification</label>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Revenue Type</label>
                    <select name="revenue_type" class="form-select">
                        <option value="" {{ 'selected' if not product or not product.revenue_type }}>— None —</option>
                        <option value="product_sales" {{ 'selected' if product and product.revenue_type == 'product_sales' }}>Product Sales Revenue</option>
                        <option value="service" {{ 'selected' if product and product.revenue_type == 'service' }}>Service Revenue</option>
                        <option value="contract" {{ 'selected' if product and product.revenue_type == 'contract' }}>Contract Revenue</option>
                        <option value="recurring" {{ 'selected' if product and product.revenue_type == 'recurring' }}>Recurring Revenue</option>
                        <option value="project" {{ 'selected' if product and product.revenue_type == 'project' }}>Project Revenue</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cost Behavior</label>
                    <select name="cost_behavior" class="form-select">
                        <option value="" {{ 'selected' if not product or not product.cost_behavior }}>— None —</option>
                        <option value="direct" {{ 'selected' if product and product.cost_behavior == 'direct' }}>Direct Cost Item</option>
                        <option value="indirect" {{ 'selected' if product and product.cost_behavior == 'indirect' }}>Indirect Cost Item</option>
                        <option value="billable" {{ 'selected' if product and product.cost_behavior == 'billable' }}>Billable Expense</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tax Type</label>
                    <select name="tax_type" class="form-select">
                        <option value="taxable" {{ 'selected' if not product or product.tax_type == 'taxable' }}>Taxable</option>
                        <option value="zero_rated" {{ 'selected' if product and product.tax_type == 'zero_rated' }}>Zero-rated</option>
                        <option value="exempt" {{ 'selected' if product and product.tax_type == 'exempt' }}>Exempt</option>
                    </select>
                </div>

                <!-- ─── PRICING SECTION ─────────────────────────── -->
                <div class="col-12">
                    <hr class="my-1">
                    <label class="form-label fw-bold" style="font-size:0.9rem;"><i class="bi bi-tags me-1"></i>Pricing & Markup</label>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Cost Price</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" name="cost_price" id="costPrice" class="form-control" step="0.01" min="0"
                               value="{{ product.cost_price if product else 0 }}" oninput="calcPrice()">
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Markup</label>
                    <div class="input-group">
                        <input type="number" id="markupValue" class="form-control" step="0.01" min="0" value="0" oninput="calcPrice()">
                        <select id="markupType" class="form-select" style="max-width:80px;" onchange="calcPrice()">
                            <option value="percent" selected>%</option>
                            <option value="dollar">$</option>
                        </select>
                    </div>
                    <div class="form-text text-muted" id="markupHint">Enter desired profit margin</div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Selling Price</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" name="selling_price" id="sellingPrice" class="form-control" step="0.01" min="0"
                               value="{{ product.selling_price if product else 0 }}" oninput="reverseCalc()">
                    </div>
                </div>

                <!-- Profit Preview -->
                <div class="col-12">
                    <div id="profitPreview" class="d-flex flex-wrap gap-3 p-3 rounded" style="background:var(--body-bg); display:none;">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted" style="font-size:0.78rem;">Profit per unit:</span>
                            <strong id="profitAmount" style="font-size:0.95rem;" class="text-success">$0.00</strong>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted" style="font-size:0.78rem;">Margin:</span>
                            <strong id="profitPercent" style="font-size:0.95rem;">0%</strong>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted" style="font-size:0.78rem;">Markup:</span>
                            <strong id="markupPercent" style="font-size:0.95rem;">0%</strong>
                        </div>
                    </div>
                </div>

                <!-- ─── END PRICING ─────────────────────────────── -->

                {% if not is_service_business %}
                <div class="col-md-4">
                    <label class="form-label">Reorder Level</label>
                    <input type="number" name="reorder_level" class="form-control" step="0.01" min="0" value="{{ product.reorder_level if product else 0 }}">
                </div>
                {% if not product %}
                <div class="col-md-4 product-only">
                    <label class="form-label">Opening Stock</label>
                    <input type="number" name="quantity_on_hand" class="form-control" step="0.01" min="0" value="0">
                </div>
                {% endif %}
                {% endif %}
                <div class="col-md-12">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-control" rows="2">{{ product.description if product else '' }}</textarea>
                </div>
            </div>
            <div class="mt-4">
                <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>{{ 'Update' if product else 'Create' }}</button>
                <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ─── Sub-category definitions ──────────────────────────
var PRODUCT_SUB_CATEGORIES = [
    {value: 'trading_goods', label: 'Trading Goods', hint: 'Retail merchandise, wholesale goods, imported goods'},
    {value: 'raw_materials', label: 'Raw Materials', hint: 'Production materials, ingredients, construction materials'},
    {value: 'work_in_progress', label: 'Work-in-Progress', hint: 'Semi-finished goods'},
    {value: 'finished_goods', label: 'Finished Goods', hint: 'Manufactured / assembled products'},
    {value: 'spare_parts', label: 'Spare Parts', hint: 'Auto parts, machinery parts, replacement components'},
    {value: 'fixed_assets_for_sale', label: 'Fixed Assets for Sale', hint: 'Equipment, vehicles, property for resale'},
];
var SERVICE_SUB_CATEGORIES = [
    {value: 'professional_services', label: 'Professional Services', hint: 'Consulting, IT support, legal, accounting'},
    {value: 'repair_maintenance', label: 'Repair & Maintenance', hint: 'Labor charge, installation, workshop service'},
    {value: 'fnb_services', label: 'F&B Services', hint: 'Catering, event service, service charge'},
    {value: 'rental_leasing', label: 'Rental & Leasing', hint: 'Equipment, property, vehicle rental'},
    {value: 'commission_agency', label: 'Commission & Agency', hint: 'Sales commission, brokerage, agency fee'},
    {value: 'education_training', label: 'Education & Training', hint: 'Course fee, training, workshop'},
    {value: 'healthcare_services', label: 'Healthcare Services', hint: 'Consultation, medical service, lab test'},
];

var currentItemType = '{{ "service" if is_service_business else (product.item_type if product else "product") }}';
var currentSubCat = '{{ product.sub_category if product else "" }}';
var isServiceBusiness = {{ 'true' if is_service_business else 'false' }};

function selectItemType(type) {
    currentItemType = type;
    document.getElementById('itemType').value = type;
    document.querySelectorAll('.item-type-card').forEach(c => {
        c.classList.remove('active', 'border-primary', 'border-success');
    });
    if (type === 'service') {
        document.getElementById('card-service').classList.add('active', 'border-success');
        // Hide stock-related fields
        document.querySelectorAll('.product-only').forEach(el => el.style.display = 'none');
    } else {
        document.getElementById('card-product').classList.add('active', 'border-primary');
        document.querySelectorAll('.product-only').forEach(el => el.style.display = '');
    }
    populateSubCategories(type);
    filterCategories(type);
}

function populateSubCategories(type) {
    var sel = document.getElementById('subCategory');
    var list = type === 'service' ? SERVICE_SUB_CATEGORIES : PRODUCT_SUB_CATEGORIES;
    sel.innerHTML = '<option value="">— Select Sub-Category —</option>';
    list.forEach(function(sc) {
        var opt = document.createElement('option');
        opt.value = sc.value;
        opt.textContent = sc.label;
        opt.title = sc.hint;
        if (sc.value === currentSubCat) opt.selected = true;
        sel.appendChild(opt);
    });
}

function filterCategories(type) {
    var sel = document.getElementById('categorySelect');
    if (!sel) return;
    var opts = sel.querySelectorAll('option[data-type]');
    opts.forEach(function(opt) {
        var catType = opt.getAttribute('data-type');
        opt.style.display = (catType === type || catType === '') ? '' : 'none';
    });
}

// Initialize on page load
if (isServiceBusiness) {
    // Service business: always service type, populate sub-categories only
    populateSubCategories('service');
    filterCategories('service');
} else {
    selectItemType(currentItemType);
}

// ─── Price calculation ─────────────────────────────────
var costEl = document.getElementById('costPrice');
var sellEl = document.getElementById('sellingPrice');
var markupVal = document.getElementById('markupValue');
var markupType = document.getElementById('markupType');
var profitAmt = document.getElementById('profitAmount');
var profitPct = document.getElementById('profitPercent');
var markupPct = document.getElementById('markupPercent');
var preview = document.getElementById('profitPreview');

function calcPrice() {
    var cost = parseFloat(costEl.value) || 0;
    var markup = parseFloat(markupVal.value) || 0;
    var type = markupType.value;
    var sell;

    if (type === 'percent') {
        sell = cost + (cost * markup / 100);
    } else {
        sell = cost + markup;
    }

    sellEl.value = sell.toFixed(2);
    updatePreview(cost, sell);
}

function reverseCalc() {
    var cost = parseFloat(costEl.value) || 0;
    var sell = parseFloat(sellEl.value) || 0;
    var type = markupType.value;
    var profit = sell - cost;

    if (type === 'percent') {
        markupVal.value = cost > 0 ? ((profit / cost) * 100).toFixed(2) : 0;
    } else {
        markupVal.value = profit.toFixed(2);
    }

    updatePreview(cost, sell);
}

function updatePreview(cost, sell) {
    var profit = sell - cost;
    var margin = sell > 0 ? (profit / sell) * 100 : 0;
    var markup = cost > 0 ? (profit / cost) * 100 : 0;

    profitAmt.textContent = '$' + profit.toFixed(2);
    profitAmt.className = profit >= 0 ? 'text-success' : 'text-danger';
    profitPct.textContent = margin.toFixed(1) + '%';
    profitPct.className = margin >= 0 ? 'text-success' : 'text-danger';
    markupPct.textContent = markup.toFixed(1) + '%';
    markupPct.className = markup >= 0 ? '' : 'text-danger';

    preview.style.display = (cost > 0 || sell > 0) ? '' : 'none';
}

// Init on edit mode
(function() {
    var cost = parseFloat(costEl.value) || 0;
    var sell = parseFloat(sellEl.value) || 0;
    if (cost > 0 && sell > 0) {
        reverseCalc();
    }
})();
</script>
{% endblock %}
