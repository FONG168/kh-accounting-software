{% extends "base.html" %}
{% block title %}Live Chat Support{% endblock %}
{% block extra_css %}
<style>
    .chat-container { display:flex; flex-direction:column; height:calc(100vh - 220px); min-height:400px; }
    .chat-messages { flex:1; overflow-y:auto; padding:1.5rem; background:#f8fafc; border-radius:12px 12px 0 0; }
    .chat-bubble { max-width:70%; margin-bottom:1rem; padding:.75rem 1rem; border-radius:16px; position:relative; word-wrap:break-word; }
    .chat-bubble.mine { background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; margin-left:auto; border-bottom-right-radius:4px; }
    .chat-bubble.theirs { background:#fff; border:1px solid #e2e8f0; margin-right:auto; border-bottom-left-radius:4px; }
    .chat-bubble .chat-time { font-size:.7rem; opacity:.7; margin-top:.25rem; }
    .chat-bubble.mine .chat-time { text-align:right; color:rgba(255,255,255,.7); }
    .chat-bubble.theirs .chat-time { color:#94a3b8; }
    .chat-sender { font-size:.7rem; font-weight:600; margin-bottom:.15rem; }
    .chat-bubble.theirs .chat-sender { color:#3b82f6; }
    .chat-input-bar { display:flex; gap:.5rem; padding:1rem; background:#fff; border:1px solid #e2e8f0; border-radius:0 0 12px 12px; border-top:0; }
    .chat-input-bar input { flex:1; border:1px solid #e2e8f0; border-radius:24px; padding:.5rem 1rem; font-size:.9rem; outline:none; }
    .chat-input-bar input:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    .chat-input-bar button { border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border:none; background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; flex-shrink:0; }
    .chat-input-bar button:hover { background:linear-gradient(135deg,#2563eb,#1d4ed8); }
</style>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="fw-bold mb-1"><i class="bi bi-chat-dots me-2"></i>Live Chat Support</h3>
        <p class="text-muted mb-0">Chat with our support team for assistance</p>
    </div>
</div>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        {% if not messages %}
        <div class="text-center text-muted py-5">
            <i class="bi bi-headset" style="font-size:2.5rem;"></i>
            <h5 class="mt-3 fw-semibold">Welcome to Live Chat Support</h5>
            <p>Send a message and our support team will respond as soon as possible.</p>
        </div>
        {% endif %}
        {% for msg in messages %}
        <div class="chat-bubble {{ 'mine' if msg.sender_id == current_user.id else 'theirs' }}" data-msg-id="{{ msg.id }}">
            {% if msg.sender_id != current_user.id %}
            <div class="chat-sender"><i class="bi bi-headset me-1"></i>Support Team</div>
            {% endif %}
            {{ msg.message }}
            <div class="chat-time">{{ msg.created_at.strftime('%b %d, %I:%M %p') }}</div>
        </div>
        {% endfor %}
    </div>
    <form method="POST" action="{{ url_for('chat.send') }}" class="chat-input-bar" id="chatForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="message" placeholder="Type your message..." autocomplete="off" required id="chatInput">
        <button type="submit" title="Send"><i class="bi bi-send-fill"></i></button>
    </form>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
    var container = document.getElementById('chatMessages');
    var lastId = 0;
    // Find last message ID
    var bubbles = container.querySelectorAll('.chat-bubble[data-msg-id]');
    if(bubbles.length) lastId = parseInt(bubbles[bubbles.length-1].dataset.msgId) || 0;
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;

    // Poll for new messages every 3 seconds
    setInterval(function(){
        fetch('{{ url_for("chat.messages_api") }}?after=' + lastId)
        .then(function(r){ return r.json(); })
        .then(function(msgs){
            if(!msgs.length) return;
            // Remove placeholder
            var placeholder = container.querySelector('.text-center.text-muted');
            if(placeholder) placeholder.remove();
            msgs.forEach(function(m){
                var div = document.createElement('div');
                div.className = 'chat-bubble ' + (m.is_mine ? 'mine' : 'theirs');
                div.dataset.msgId = m.id;
                var html = '';
                if(!m.is_mine) html += '<div class="chat-sender"><i class="bi bi-headset me-1"></i>Support Team</div>';
                html += m.message + '<div class="chat-time">' + m.time + '</div>';
                div.innerHTML = html;
                container.appendChild(div);
                lastId = m.id;
            });
            container.scrollTop = container.scrollHeight;
        }).catch(function(){});
    }, 3000);
})();
</script>
{% endblock %}
