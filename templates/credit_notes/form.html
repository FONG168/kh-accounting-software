{% extends "base.html" %}
{% block title %}{{ 'Edit' if cn else 'New' }} Credit Note{% endblock %}
{% block content %}
<div class="page-header">
    <h2><i class="bi bi-receipt-cutoff me-2"></i>{{ 'Edit' if cn else 'New' }} Credit Note</h2>
    <a href="{{ url_for('credit_notes.index') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-1"></i>Back</a>
</div>

<form method="POST" id="cnForm">
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Customer <span class="text-danger">*</span></label>
                    <select name="customer_id" class="form-select" required>
                        <option value="">-- Select Customer --</option>
                        {% for c in customers %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" name="date" class="form-control" value="{{ today.isoformat() }}" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Linked Invoice</label>
                    <select name="invoice_id" class="form-select">
                        <option value="">-- None --</option>
                        {% for inv in invoices %}
                        <option value="{{ inv.id }}">{{ inv.invoice_number }} â€“ {{ inv.customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Tax Rate %</label>
                    <input type="number" name="tax_rate" class="form-control" step="0.01" value="0" min="0">
                </div>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-12">
                    <label class="form-label">Reason</label>
                    <textarea name="reason" class="form-control" rows="2" placeholder="Reason for credit note"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Line Items -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Line Items</h6>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCNLine()"><i class="bi bi-plus-circle me-1"></i>Add Line</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
            <table class="table mb-0" id="cnLines">
                <thead>
                    <tr>
                        <th style="width:25%">Product</th>
                        <th>Description</th>
                        <th style="width:10%">Qty</th>
                        <th style="width:12%">Unit Price</th>
                        <th style="width:12%" class="text-end">Amount</th>
                        <th style="width:5%"></th>
                    </tr>
                </thead>
                <tbody id="cnLineBody">
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <input type="hidden" name="item_count" id="itemCount" value="0">
    <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-1"></i>Create Credit Note</button>
</form>

<script>
let cnLineIdx = 0;
const products = {{ products | tojson | safe if products else '[]' }};

function addCNLine() {
    const tbody = document.getElementById('cnLineBody');
    const idx = cnLineIdx++;
    let productOpts = '<option value="">-- None --</option>';
    products.forEach(p => {
        productOpts += `<option value="${p.id}" data-price="${p.selling_price}">${p.name}</option>`;
    });
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><select name="items-${idx}-product_id" class="form-select form-select-sm" onchange="cnProductPick(this, ${idx})">${productOpts}</select></td>
        <td><input name="items-${idx}-description" class="form-control form-control-sm" required></td>
        <td><input name="items-${idx}-quantity" type="number" class="form-control form-control-sm" value="1" min="0.01" step="any" onchange="calcCNLine(${idx})"></td>
        <td><input name="items-${idx}-unit_price" type="number" class="form-control form-control-sm" value="0" min="0" step="any" onchange="calcCNLine(${idx})"></td>
        <td class="text-end amount" id="cn-line-amt-${idx}">0.00</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); updateCNCount()"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(row);
    updateCNCount();
}

function cnProductPick(sel, idx) {
    const opt = sel.options[sel.selectedIndex];
    const price = opt.dataset.price || 0;
    const form = document.getElementById('cnForm');
    form.querySelector(`[name="items-${idx}-description"]`).value = opt.text !== '-- None --' ? opt.text : '';
    form.querySelector(`[name="items-${idx}-unit_price"]`).value = price;
    calcCNLine(idx);
}

function calcCNLine(idx) {
    const form = document.getElementById('cnForm');
    const qty = parseFloat(form.querySelector(`[name="items-${idx}-quantity"]`).value) || 0;
    const price = parseFloat(form.querySelector(`[name="items-${idx}-unit_price"]`).value) || 0;
    document.getElementById(`cn-line-amt-${idx}`).textContent = (qty * price).toFixed(2);
}

function updateCNCount() {
    document.getElementById('itemCount').value = cnLineIdx;
}

// Start with one line
addCNLine();
</script>
{% endblock %}
