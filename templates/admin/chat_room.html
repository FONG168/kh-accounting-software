{% extends "admin/base_admin.html" %}
{% block title %}Chat with {{ other_user.full_name }} — System Admin{% endblock %}
{% block page_title %}Chat — {{ other_user.full_name }}{% endblock %}
{% block extra_css %}
<style>
    .chat-container { display:flex; flex-direction:column; height:calc(100vh - 220px); min-height:400px; }
    .chat-messages { flex:1; overflow-y:auto; padding:1.5rem; background:var(--admin-bg); border:1px solid var(--admin-border); border-radius:12px 12px 0 0; }
    .chat-bubble { max-width:70%; margin-bottom:1rem; padding:.75rem 1rem; border-radius:16px; position:relative; word-wrap:break-word; }
    .chat-bubble.mine { background:linear-gradient(135deg,#6366f1,#4f46e5); color:#fff; margin-left:auto; border-bottom-right-radius:4px; }
    .chat-bubble.theirs { background:var(--admin-surface); border:1px solid var(--admin-border); color:var(--admin-text); margin-right:auto; border-bottom-left-radius:4px; }
    .chat-bubble .chat-time { font-size:.7rem; opacity:.7; margin-top:.25rem; }
    .chat-bubble.mine .chat-time { text-align:right; color:rgba(255,255,255,.7); }
    .chat-bubble.theirs .chat-time { color:var(--admin-text-muted); }
    .chat-input-bar { display:flex; gap:.5rem; padding:1rem; background:var(--admin-surface); border:1px solid var(--admin-border); border-radius:0 0 12px 12px; border-top:0; }
    .chat-input-bar input { flex:1; border:1px solid var(--admin-border); border-radius:24px; padding:.5rem 1rem; font-size:.9rem; outline:none; background:var(--admin-bg); color:var(--admin-text); }
    .chat-input-bar input:focus { border-color:var(--admin-accent); box-shadow:0 0 0 3px rgba(99,102,241,.2); }
    .chat-input-bar button { border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border:none; background:linear-gradient(135deg,#6366f1,#4f46e5); color:#fff; flex-shrink:0; }
    .chat-input-bar button:hover { background:linear-gradient(135deg,#4f46e5,#4338ca); }
</style>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
        <a href="{{ url_for('admin.chat_list') }}" class="btn btn-outline-light btn-sm">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div class="d-flex align-items-center">
            <div class="rounded-circle d-flex align-items-center justify-content-center me-2" style="width:40px;height:40px;background:rgba(99,102,241,.15);">
                <span class="fw-bold" style="color:var(--admin-accent);">{{ other_user.full_name[:2]|upper }}</span>
            </div>
            <div>
                <h6 class="mb-0 fw-semibold">{{ other_user.full_name }}</h6>
                <small style="color:var(--admin-text-muted);">{{ other_user.email }}</small>
            </div>
        </div>
    </div>
    <a href="{{ url_for('admin.user_detail', user_id=other_user.id) }}" class="btn btn-sm btn-outline-light">
        <i class="bi bi-person-gear me-1"></i>Manage User
    </a>
</div>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        {% if not messages %}
        <div class="text-center py-5" style="color:var(--admin-text-muted);">
            <i class="bi bi-chat" style="font-size:2rem;"></i>
            <p class="mt-2">No messages yet. Start the conversation.</p>
        </div>
        {% endif %}
        {% for msg in messages %}
        <div class="chat-bubble {{ 'mine' if msg.sender_id == current_user.id else 'theirs' }}" data-msg-id="{{ msg.id }}">
            {{ msg.message }}
            <div class="chat-time">{{ msg.created_at.strftime('%b %d, %I:%M %p') }}</div>
        </div>
        {% endfor %}
    </div>
    <form method="POST" action="{{ url_for('admin.chat_send', user_id=other_user.id) }}" class="chat-input-bar" id="chatForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="message" placeholder="Type your message..." autocomplete="off" required id="chatInput">
        <button type="submit" title="Send"><i class="bi bi-send-fill"></i></button>
    </form>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
    var container = document.getElementById('chatMessages');
    var lastId = 0;
    // Find last message ID
    var bubbles = container.querySelectorAll('.chat-bubble[data-msg-id]');
    if(bubbles.length) lastId = parseInt(bubbles[bubbles.length-1].dataset.msgId) || 0;
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;

    // Poll for new messages every 3 seconds
    setInterval(function(){
        fetch('{{ url_for("admin.chat_messages_api", user_id=other_user.id) }}?after=' + lastId)
        .then(function(r){ return r.json(); })
        .then(function(msgs){
            if(!msgs.length) return;
            // Remove "no messages" placeholder
            var placeholder = container.querySelector('.text-center.text-muted');
            if(placeholder) placeholder.remove();
            msgs.forEach(function(m){
                var div = document.createElement('div');
                div.className = 'chat-bubble ' + (m.is_mine ? 'mine' : 'theirs');
                div.dataset.msgId = m.id;
                div.innerHTML = m.message + '<div class="chat-time">' + m.time + '</div>';
                container.appendChild(div);
                lastId = m.id;
            });
            container.scrollTop = container.scrollHeight;
        }).catch(function(){});
    }, 3000);
})();
</script>
{% endblock %}
