<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}KH Accounting Software Enterprise{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <script>
        /* Apply saved theme BEFORE render to prevent flash */
        (function(){
            var t = localStorage.getItem('accubooks-theme') || 'light';
            document.documentElement.setAttribute('data-theme', t);
        })();
    </script>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="brand-logo-wrap">
                <div class="brand-monogram">KH</div>
                <div class="brand-text">
                    <span class="brand-name">Accounting Software</span>
                    <span class="brand-edition">Enterprise</span>
                </div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('dashboard') %}active{% endif %}">
                <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>

            <div class="sidebar-section">SALES</div>
            <a href="{{ url_for('customers.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('customers') %}active{% endif %}">
                <i class="bi bi-people"></i> <span>Customers</span>
            </a>
            <a href="{{ url_for('sales.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('sales') %}active{% endif %}">
                <i class="bi bi-receipt"></i> <span>Invoices / Sales</span>
            </a>
            <a href="{{ url_for('sales.payments') }}" class="sidebar-link {% if request.endpoint and 'payment' in (request.endpoint or '') and 'sales' in (request.endpoint or '') %}active{% endif %}">
                <i class="bi bi-cash-stack"></i> <span>Payments Received</span>
            </a>

            <div class="sidebar-section">PURCHASES</div>
            <a href="{{ url_for('vendors.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('vendors') %}active{% endif %}">
                <i class="bi bi-truck"></i> <span>Vendors</span>
            </a>
            <a href="{{ url_for('purchases.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('purchases') %}active{% endif %}">
                <i class="bi bi-bag"></i> <span>Bills / Purchases</span>
            </a>
            <a href="{{ url_for('purchases.payments') }}" class="sidebar-link {% if request.endpoint and 'payment' in (request.endpoint or '') and 'purchases' in (request.endpoint or '') %}active{% endif %}">
                <i class="bi bi-wallet2"></i> <span>Payments Made</span>
            </a>

            <div class="sidebar-section">{% if is_service_business %}SERVICES{% else %}INVENTORY{% endif %}</div>
            <a href="{{ url_for('inventory.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('inventory') %}active{% endif %}">
                <i class="bi {{ 'bi-tools' if is_service_business else 'bi-box-seam' }}"></i> <span>{% if is_service_business %}Services{% else %}Products & Services{% endif %}</span>
            </a>
            <a href="{{ url_for('categories.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('categories') %}active{% endif %}">
                <i class="bi bi-tags"></i> <span>Categories</span>
            </a>
            {% if not is_service_business %}
            <a href="{{ url_for('inventory.stock_movements') }}" class="sidebar-link {% if request.endpoint and 'stock' in (request.endpoint or '') %}active{% endif %}">
                <i class="bi bi-arrow-left-right"></i> <span>Stock Movements</span>
            </a>
            {% endif %}

            <div class="sidebar-section">PETTY CASH</div>
            <a href="{{ url_for('expenses.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('expenses') %}active{% endif %}">
                <i class="bi bi-cash-coin"></i> <span>Petty Cash</span>
            </a>

            <div class="sidebar-section">ACCOUNTING</div>
            <a href="{{ url_for('accounts.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('accounts') %}active{% endif %}">
                <i class="bi bi-list-columns-reverse"></i> <span>Chart of Accounts</span>
            </a>
            <a href="{{ url_for('journal.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('journal') %}active{% endif %}">
                <i class="bi bi-journal-text"></i> <span>Journal Entries</span>
            </a>
            <a href="{{ url_for('credit_notes.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('credit_notes') %}active{% endif %}">
                <i class="bi bi-receipt-cutoff"></i> <span>Credit Notes</span>
            </a>
            <a href="{{ url_for('debit_notes.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('debit_notes') %}active{% endif %}">
                <i class="bi bi-receipt"></i> <span>Debit Notes</span>
            </a>

            <div class="sidebar-section">REPORTS</div>
            <a href="{{ url_for('reports.profit_loss') }}" class="sidebar-link {% if request.endpoint == 'reports.profit_loss' %}active{% endif %}">
                <i class="bi bi-graph-up-arrow"></i> <span>Profit & Loss</span>
            </a>
            <a href="{{ url_for('reports.balance_sheet') }}" class="sidebar-link {% if request.endpoint == 'reports.balance_sheet' %}active{% endif %}">
                <i class="bi bi-clipboard-data"></i> <span>Balance Sheet</span>
            </a>
            <a href="{{ url_for('reports.trial_balance') }}" class="sidebar-link {% if request.endpoint == 'reports.trial_balance' %}active{% endif %}">
                <i class="bi bi-file-earmark-spreadsheet"></i> <span>Trial Balance</span>
            </a>
            <a href="{{ url_for('reports.cash_flow') }}" class="sidebar-link {% if request.endpoint == 'reports.cash_flow' %}active{% endif %}">
                <i class="bi bi-currency-dollar"></i> <span>Cash Flow</span>
            </a>
            <a href="{{ url_for('reports.equity_statement') }}" class="sidebar-link {% if request.endpoint == 'reports.equity_statement' %}active{% endif %}">
                <i class="bi bi-bank"></i> <span>Changes in Equity</span>
            </a>
            <a href="{{ url_for('reports.general_ledger') }}" class="sidebar-link {% if request.endpoint == 'reports.general_ledger' %}active{% endif %}">
                <i class="bi bi-book"></i> <span>General Ledger</span>
            </a>
            <a href="{{ url_for('reports.sales_report') }}" class="sidebar-link {% if request.endpoint == 'reports.sales_report' %}active{% endif %}">
                <i class="bi bi-bar-chart-line"></i> <span>Sales Report</span>
            </a>
            <a href="{{ url_for('reports.expense_report') }}" class="sidebar-link {% if request.endpoint == 'reports.expense_report' %}active{% endif %}">
                <i class="bi bi-pie-chart"></i> <span>Expense Report</span>
            </a>
            {% if not is_service_business %}
            <a href="{{ url_for('reports.inventory_report') }}" class="sidebar-link {% if request.endpoint == 'reports.inventory_report' %}active{% endif %}">
                <i class="bi bi-boxes"></i> <span>Inventory Report</span>
            </a>
            {% endif %}
            <a href="{{ url_for('reports.budget_vs_actual') }}" class="sidebar-link {% if request.endpoint == 'reports.budget_vs_actual' %}active{% endif %}">
                <i class="bi bi-bar-chart-steps"></i> <span>Budget vs Actual</span>
            </a>
            <a href="{{ url_for('reports.ar_aging') }}" class="sidebar-link {% if request.endpoint == 'reports.ar_aging' %}active{% endif %}">
                <i class="bi bi-hourglass-split"></i> <span>AR Aging</span>
            </a>
            <a href="{{ url_for('reports.ap_aging') }}" class="sidebar-link {% if request.endpoint == 'reports.ap_aging' %}active{% endif %}">
                <i class="bi bi-hourglass-bottom"></i> <span>AP Aging</span>
            </a>
            <a href="{{ url_for('reports.customer_statement') }}" class="sidebar-link {% if request.endpoint == 'reports.customer_statement' %}active{% endif %}">
                <i class="bi bi-person-lines-fill"></i> <span>Customer Statement</span>
            </a>
            <a href="{{ url_for('reports.vendor_statement') }}" class="sidebar-link {% if request.endpoint == 'reports.vendor_statement' %}active{% endif %}">
                <i class="bi bi-truck"></i> <span>Vendor Statement</span>
            </a>

            <div class="sidebar-section">SETTINGS</div>
            <a href="{{ url_for('setup.settings') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('setup') %}active{% endif %}">
                <i class="bi bi-gear"></i> <span>Company Settings</span>
            </a>
            <a href="{{ url_for('fiscal.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('fiscal') %}active{% endif %}">
                <i class="bi bi-calendar-check"></i> <span>Fiscal Periods</span>
            </a>
            <a href="{{ url_for('budgets.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('budgets') %}active{% endif %}">
                <i class="bi bi-piggy-bank"></i> <span>Budgets</span>
            </a>
            <a href="{{ url_for('audit.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('audit') %}active{% endif %}">
                <i class="bi bi-shield-check"></i> <span>Audit Log</span>
            </a>

            {% if current_user.is_authenticated and not current_user.is_superadmin %}
            <div class="sidebar-section">SUPPORT</div>
            <a href="{{ url_for('chat.index') }}" class="sidebar-link {% if request.endpoint and request.endpoint.startswith('chat') %}active{% endif %}">
                <i class="bi bi-headset"></i> <span>Live Chat Support</span>
            </a>
            {% endif %}
        </nav>
    </div>

    <!-- Sidebar overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navbar -->
        <nav class="top-navbar">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-link sidebar-toggle" id="sidebarToggle">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <!-- Search trigger -->
                <button class="btn btn-sm btn-outline-secondary d-none d-md-flex align-items-center gap-2" onclick="openCommandPalette()" style="min-width:200px;justify-content:space-between;">
                    <span><i class="bi bi-search me-1"></i> Search&hellip;</span>
                    <kbd style="font-size:0.65rem;background:var(--body-bg);border:1px solid var(--border);border-radius:4px;padding:1px 6px;">Ctrl K</kbd>
                </button>
            </div>
            <div class="d-flex align-items-center gap-3">
                {% if firebase_cloud_sync %}
                <span class="badge bg-success-subtle text-success-emphasis rounded-pill" title="Cloud Sync active">
                    <i class="bi bi-cloud-check-fill me-1"></i>Cloud Sync
                </span>
                {% else %}
                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill" title="Local database only">
                    <i class="bi bi-cloud-slash me-1"></i>Local
                </span>
                {% endif %}
                <span class="company-name d-none d-lg-inline">{{ config.COMPANY_NAME }}</span>
                <!-- Dark Mode Toggle -->
                <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                    <i class="bi bi-moon-stars-fill"></i>
                </button>
                {% if current_user.is_authenticated %}
                <div class="dropdown">
                    <button class="btn btn-sm p-0 border-0" type="button" data-bs-toggle="dropdown" style="background:none;">
                        <div class="user-avatar" title="{{ current_user.full_name }}">{{ current_user.full_name[:2]|upper }}</div>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="px-3 py-2"><small class="text-muted">Signed in as</small><br><strong>{{ current_user.full_name }}</strong></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('setup.settings') }}"><i class="bi bi-gear me-2"></i>Settings</a></li>
                        {% if not current_user.is_superadmin %}
                        <li><a class="dropdown-item" href="{{ url_for('chat.index') }}"><i class="bi bi-headset me-2"></i>Live Chat Support</a></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </nav>

        <!-- Toast Notifications (replaces flash) -->
        <div class="toast-container" id="toastContainer">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="toast-msg {{ category if category != 'message' else 'info' }}" data-auto-dismiss="5000">
                            <i class="bi {% if category == 'success' %}bi-check-circle-fill{% elif category == 'danger' %}bi-exclamation-triangle-fill{% elif category == 'warning' %}bi-exclamation-circle-fill{% else %}bi-info-circle-fill{% endif %}"></i>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- Page Content -->
        <div class="page-content">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Command Palette / Global Search -->
    <div class="cmd-backdrop" id="cmdBackdrop">
        <div class="cmd-palette" id="cmdPalette">
            <input type="text" id="cmdInput" placeholder="Search customers, invoices, products, or type a commandâ€¦" autocomplete="off">
            <div class="cmd-results" id="cmdResults">
                <div class="cmd-item" onclick="window.location='/dashboard'"><i class="bi bi-speedometer2"></i> Dashboard <span class="cmd-shortcut">Page</span></div>
                <div class="cmd-item" onclick="window.location='/sales/new'"><i class="bi bi-plus-circle"></i> New Invoice <span class="cmd-shortcut">Action</span></div>
                <div class="cmd-item" onclick="window.location='/purchases/new'"><i class="bi bi-plus-circle"></i> New Bill <span class="cmd-shortcut">Action</span></div>
                <div class="cmd-item" onclick="window.location='/expenses/new'"><i class="bi bi-cash-coin"></i> New Petty Cash <span class="cmd-shortcut">Action</span></div>
                <div class="cmd-item" onclick="window.location='/journal/new'"><i class="bi bi-journal-plus"></i> New Journal Entry <span class="cmd-shortcut">Action</span></div>
                <div class="cmd-item" onclick="window.location='/reports/profit-loss'"><i class="bi bi-graph-up-arrow"></i> Profit & Loss <span class="cmd-shortcut">Report</span></div>
                <div class="cmd-item" onclick="window.location='/reports/balance-sheet'"><i class="bi bi-clipboard-data"></i> Balance Sheet <span class="cmd-shortcut">Report</span></div>
                <div class="cmd-item" onclick="window.location='/reports/cash-flow'"><i class="bi bi-currency-dollar"></i> Cash Flow <span class="cmd-shortcut">Report</span></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js"></script>
    <script>
    /* Auto-inject CSRF token into all forms */
    (function(){
        var token = document.querySelector('meta[name="csrf-token"]');
        if(!token) return;
        var val = token.getAttribute('content');
        document.addEventListener('DOMContentLoaded', function(){
            document.querySelectorAll('form').forEach(function(form){
                if(form.method && form.method.toUpperCase() === 'GET') return;
                if(form.querySelector('input[name="csrf_token"]')) return;
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrf_token';
                input.value = val;
                form.appendChild(input);
            });
        });
        /* Also add header for AJAX requests */
        var origFetch = window.fetch;
        window.fetch = function(url, opts){
            opts = opts || {};
            if(opts.method && opts.method.toUpperCase() !== 'GET'){
                opts.headers = opts.headers || {};
                opts.headers['X-CSRFToken'] = val;
            }
            return origFetch(url, opts);
        };
    })();
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
